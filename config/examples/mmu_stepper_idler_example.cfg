# Happy Hare MMU - Example configuration for StepperIdlerSelector
#
# This configuration is for MMU designs using stepper motors for both
# selector and idler movements (like Prusa MMU2S or similar designs).
#
# The StepperIdlerSelector uses:
# - A stepper motor for selector movement (part of MMU toolhead)
# - A manual_stepper for idler movement (separate configuration)
#
# This is an alternative to servo-based idler designs.

# ====================================================================
# MMU MACHINE CONFIGURATION
# ====================================================================
[mmu_machine]
# Number of gates (filament slots)
num_gates: 5

# Set vendor to "Other" for custom setup
mmu_vendor: Other
mmu_version: 1.0

# Use StepperIdlerSelector instead of default LinearSelector
selector_type: StepperIdlerSelector

# MMU design parameters
variable_rotation_distances: 1
variable_bowden_lengths: 0
require_bowden_move: 1
filament_always_gripped: 0
has_bypass: 0


# ====================================================================
# SELECTOR STEPPER (Part of MMU toolhead)
# ====================================================================
[tmc2209 stepper_mmu_selector]
uart_pin: mmu:MMU_SEL_UART
run_current: 0.4
hold_current: 0.2
interpolate: True
sense_resistor: 0.110
stealthchop_threshold: 100

[stepper_mmu_selector]
step_pin: mmu:MMU_SEL_STEP
dir_pin: !mmu:MMU_SEL_DIR
enable_pin: !mmu:MMU_SEL_ENABLE
rotation_distance: 8
microsteps: 16
gear_ratio: 1:1
full_steps_per_rotation: 200
endstop_pin: ^mmu:MMU_SEL_ENDSTOP
endstop_name: mmu_sel_home


# ====================================================================
# IDLER STEPPER (Manual stepper configuration)
# ====================================================================
# This stepper moves the idler to press filament at each gate
[tmc2209 manual_stepper idler_stepper]
uart_pin: mmu:MMU_IDLER_UART
run_current: 0.4
hold_current: 0.2
interpolate: True
sense_resistor: 0.110
stealthchop_threshold: 0
# Optional: Use stallguard for sensorless homing
#diag_pin: mmu:MMU_IDLER_DIAG
#driver_SGTHRS: 130

[manual_stepper idler_stepper]
step_pin: mmu:MMU_IDLER_STEP
dir_pin: mmu:MMU_IDLER_DIR
enable_pin: !mmu:MMU_IDLER_ENABLE
rotation_distance: 128
microsteps: 16
velocity: 100
accel: 80
# Use physical endstop or stallguard
endstop_pin: ^mmu:MMU_IDLER_ENDSTOP
# For stallguard sensorless homing:
#endstop_pin: tmc2209_manual_stepper idler_stepper:virtual_endstop
#homing_retract_dist: 0


# ====================================================================
# GEAR STEPPER (Filament drive)
# ====================================================================
[tmc2209 stepper_mmu_gear]
uart_pin: mmu:MMU_GEAR_UART
run_current: 0.5
hold_current: 0.1
interpolate: True
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_mmu_gear]
step_pin: mmu:MMU_GEAR_STEP
dir_pin: !mmu:MMU_GEAR_DIR
enable_pin: !mmu:MMU_GEAR_ENABLE
rotation_distance: 22.7316868
gear_ratio: 80:20
microsteps: 16
full_steps_per_rotation: 200


# ====================================================================
# STEPPER IDLER SELECTOR PARAMETERS
# ====================================================================
[mmu_config_setup]
# Selector movement speeds
selector_move_speed: 200
selector_homing_speed: 100

# Idler movement speeds
idler_move_speed: 100
idler_homing_speed: 80

# CAD parameters for selector positions
# These define the physical positions of gates
cad_gate0_pos: 5.0              # Distance from home to first gate (mm)
cad_gate_width: 21.0             # Distance between gates (mm)
cad_last_gate_offset: 2.0        # Extra space after last gate
cad_selector_tolerance: 10.0     # Safety margin for movement

# CAD parameters for idler positions
# These should match your idler mechanism geometry
cad_idler_gate0_pos: 5.0         # Idler position for gate 0 (mm)
cad_idler_gate_width: 21.0       # Distance between idler positions (mm)
cad_idler_tolerance: 10.0        # Safety margin


# ====================================================================
# CALIBRATION
# ====================================================================
# After configuring, run these commands in order:
#
# 1. Calibrate selector positions:
#    MMU_CALIBRATE_SELECTOR
#    This calculates positions based on cad_gate0_pos and cad_gate_width
#
# 2. Calibrate idler positions:
#    MMU_CALIBRATE_IDLER
#    This calculates positions based on cad_idler_gate0_pos and cad_idler_gate_width
#
# 3. Test selector movement:
#    MMU_SOAKTEST_SELECTOR LOOP=10
#
# The calibrated positions are saved to mmu_vars.cfg as:
# - mmu_selector_offsets: [5.0, 26.0, 47.0, 68.0, 89.0]
# - mmu_idler_offsets: [5.0, 26.0, 47.0, 68.0, 89.0]
#
# You can manually adjust these in mmu_vars.cfg if needed


# ====================================================================
# SENSORS (Optional but recommended)
# ====================================================================
[mmu_sensors]
# Gate sensors detect filament at each gate
#pre_gate_switch_pin_0: ^mmu:MMU_PRE_GATE_0
#pre_gate_switch_pin_1: ^mmu:MMU_PRE_GATE_1
#pre_gate_switch_pin_2: ^mmu:MMU_PRE_GATE_2
#pre_gate_switch_pin_3: ^mmu:MMU_PRE_GATE_3
#pre_gate_switch_pin_4: ^mmu:MMU_PRE_GATE_4

# Toolhead sensor (on print head)
#toolhead_switch_pin: ^PA0

# Extruder entry sensor
#extruder_switch_pin: ^PA1


# ====================================================================
# EXAMPLE PIN MAPPINGS
# ====================================================================
# Adjust these based on your MCU board and wiring
#
# For BTT Octopus example:
# [mcu mmu]
# serial: /dev/serial/by-id/YOUR_MMU_MCU_ID
#
# [board_pins mmu_pins]
# mcu: mmu
# aliases:
#     # Selector stepper
#     MMU_SEL_STEP=PC13,
#     MMU_SEL_DIR=PF0,
#     MMU_SEL_ENABLE=PF1,
#     MMU_SEL_UART=PE4,
#     MMU_SEL_ENDSTOP=PG12,
#
#     # Idler stepper
#     MMU_IDLER_STEP=PE2,
#     MMU_IDLER_DIR=PE3,
#     MMU_IDLER_ENABLE=PD4,
#     MMU_IDLER_UART=PE1,
#     MMU_IDLER_ENDSTOP=PG14,
#     MMU_IDLER_DIAG=PG14,
#
#     # Gear stepper
#     MMU_GEAR_STEP=PE6,
#     MMU_GEAR_DIR=PA14,
#     MMU_GEAR_ENABLE=PE0,
#     MMU_GEAR_UART=PD3,
